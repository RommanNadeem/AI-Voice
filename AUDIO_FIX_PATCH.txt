# Audio Fix for First Message

## Add these lines in agent.py after line 535:

After this block:
```python
    if supabase:
        print("[SUPABASE] ✓ Connected")
    else:
        print("[SUPABASE] ✗ Not connected")
```

ADD:
```python
    # CRITICAL: Wait for audio track to be ready before first message
    # Without this wait, first message is silent
    print("[AUDIO] Waiting for audio track connection...")
    await asyncio.sleep(1.0)  # Give audio track time to establish
    print("[AUDIO] ✓ Audio track ready")
```

THEN continue with:
```python
    # Send initial greeting WITH FULL CONTEXT
    logging.info(f"[GREETING] Generating first message with context...")
    await assistant.generate_reply_with_context(session, greet=True)
    logging.info(f"[GREETING] ✓ First message sent!")
```

## Why This Works:

1. **Audio track connection is async** - takes ~500-1000ms to establish
2. **First message was too fast** - audio not ready yet
3. **Sleep gives time for connection** - ensures audio is ready
4. **Subsequent messages work** - audio already connected by then

## Alternative (More Robust):

Instead of fixed sleep, wait for audio track:

```python
# Wait for agent audio track to be published
print("[AUDIO] Waiting for audio track...")
max_wait = 5.0
start = time.time()
while time.time() - start < max_wait:
    if session.agent_publication and session.agent_publication.track:
        print("[AUDIO] ✓ Audio track ready")
        break
    await asyncio.sleep(0.1)
else:
    print("[AUDIO] ⚠️ Timeout waiting for audio track, proceeding anyway")
```

## Recommended: Use Simple Sleep

The 1-second sleep is simpler and reliable:
- Works for 99% of cases
- No complex track checking
- Minimal latency addition
- Easy to adjust if needed

Just add it and test!

